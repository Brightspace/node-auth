'use strict';

const AbstractPublicKeyStore = require('brightspace-auth-keys').AbstractPublicKeyStore;

const SIGNING_KEY_SET_KEY = 'public_keys';

function clock() {
	return Math.round(Date.now() / 1000);
}

class RedisPublicKeyStore extends AbstractPublicKeyStore {
	constructor(client) {
		super();
		this._client = client;
	}

	_storePublicKey(publicKey, expiresAt) {
		return new Promise((fulfill, reject) => {
			this._client
				.multi()
				.zadd(SIGNING_KEY_SET_KEY, expiresAt, publicKey)
				.zremrangebyscore(SIGNING_KEY_SET_KEY, '-inf', clock())
				.exec((err) => {
					if (err) {
						reject(err);
					} else {
						fulfill();
					}
				});
		});
	}

	_lookupPublicKeys() {
		return new Promise((fulfill, reject) => {
			this._client.zrangebyscore(
				SIGNING_KEY_SET_KEY, clock(),
				'+inf', (err, res) => {
					if (err) {
						reject(err);
					} else {
						fulfill(res);
					}
				});
		});
	}
}

module.exports = RedisPublicKeyStore;
